@page "/pad"
@using SyncPad.Client.Core.Services
@using SyncPad.Shared.Models
@inject IAuthManager AuthManager
@inject IApiClient ApiClient
@inject ITextHubClient TextHubClient
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>面板 - SyncPad</PageTitle>

<div class="pad-container">
    <!-- 顶部工具栏 -->
    <div class="toolbar">
        <div class="user-info">
            <span>用户: <strong>@AuthManager.Username</strong></span>
        </div>
        <div class="toolbar-actions">
            <button class="btn-secondary" @onclick="RefreshText">刷新</button>
            <button class="btn-danger" @onclick="Logout">登出</button>
        </div>
    </div>

    <!-- 文本编辑区域 -->
    <div class="editor-container">
        <textarea @bind="_content" @bind:event="oninput" @onkeyup="HandleTextChange" placeholder="在这里输入文本..."></textarea>
    </div>

    <!-- 状态栏 -->
    <div class="status-bar">
        <div class="connection-status">
            <span class="status-indicator @(_isConnected ? "connected" : "disconnected")"></span>
            <span>@_connectionStatus</span>
        </div>
    </div>
</div>

<style>
    .pad-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background-color: #f5f5f5;
    }

    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        background-color: white;
        border-bottom: 1px solid #ddd;
    }

    .user-info {
        color: #666;
    }

    .toolbar-actions {
        display: flex;
        gap: 10px;
    }

    .btn-secondary {
        padding: 8px 16px;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
    }

    .btn-danger {
        padding: 8px 16px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-danger:hover {
        background-color: #c82333;
    }

    .editor-container {
        flex: 1;
        padding: 20px;
    }

    .editor-container textarea {
        width: 100%;
        height: 100%;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        font-family: inherit;
        resize: none;
        box-sizing: border-box;
    }

    .editor-container textarea:focus {
        outline: none;
        border-color: #007bff;
    }

    .status-bar {
        padding: 10px 20px;
        background-color: white;
        border-top: 1px solid #ddd;
    }

    .connection-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #666;
    }

    .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }

    .status-indicator.connected {
        background-color: #28a745;
    }

    .status-indicator.disconnected {
        background-color: #dc3545;
    }
</style>

@code {
    private string _content = string.Empty;
    private string _connectionStatus = "未连接";
    private bool _isConnected = false;
    private bool _isUpdatingFromServer = false;
    private CancellationTokenSource? _throttleCts;
    private readonly object _throttleLock = new();

    protected override async Task OnInitializedAsync()
    {
        // 检查是否已登录
        if (!AuthManager.IsLoggedIn)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        // 订阅事件
        TextHubClient.ConnectionStateChanged += OnConnectionStateChanged;
        TextHubClient.TextUpdateReceived += OnTextUpdateReceived;

        // 连接 SignalR
        await ConnectToHub();

        // 加载初始文本
        await RefreshText();
    }

    private async Task ConnectToHub()
    {
        try
        {
            _connectionStatus = "连接中...";
            StateHasChanged();

            var hubUrl = AuthManager.GetHubUrl();
            var token = AuthManager.Token;

            if (!string.IsNullOrEmpty(token))
            {
                await TextHubClient.ConnectAsync(hubUrl, token);
            }
        }
        catch (Exception ex)
        {
            _connectionStatus = $"连接失败: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task RefreshText()
    {
        try
        {
            var response = await ApiClient.GetTextAsync();
            if (response.Success && response.Data != null)
            {
                _isUpdatingFromServer = true;
                _content = response.Data.Content;
                _isUpdatingFromServer = false;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"刷新文本失败: {ex.Message}");
        }
    }

    private void HandleTextChange()
    {
        if (!_isUpdatingFromServer)
        {
            ThrottleSendUpdate();
        }
    }

    private void ThrottleSendUpdate()
    {
        lock (_throttleLock)
        {
            _throttleCts?.Cancel();
            _throttleCts = new CancellationTokenSource();
            var token = _throttleCts.Token;
            var currentContent = _content;

            Task.Delay(300, token).ContinueWith(async _ =>
            {
                if (!token.IsCancellationRequested && TextHubClient.IsConnected)
                {
                    await TextHubClient.SendTextUpdateAsync(currentContent);
                }
            }, TaskContinuationOptions.OnlyOnRanToCompletion);
        }
    }

    private void OnConnectionStateChanged(bool connected)
    {
        InvokeAsync(() =>
        {
            _isConnected = connected;
            _connectionStatus = connected ? "已连接" : "已断开";
            StateHasChanged();
        });
    }

    private void OnTextUpdateReceived(TextSyncMessage message)
    {
        InvokeAsync(() =>
        {
            _isUpdatingFromServer = true;
            _content = message.Content;
            _isUpdatingFromServer = false;
            StateHasChanged();
        });
    }

    private async Task Logout()
    {
        await TextHubClient.DisconnectAsync();
        await AuthManager.LogoutAsync();
        Navigation.NavigateTo("/login");
    }

    public void Dispose()
    {
        TextHubClient.ConnectionStateChanged -= OnConnectionStateChanged;
        TextHubClient.TextUpdateReceived -= OnTextUpdateReceived;
        _throttleCts?.Cancel();
        _throttleCts?.Dispose();
    }
}
