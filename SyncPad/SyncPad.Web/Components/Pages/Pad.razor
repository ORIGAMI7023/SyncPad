@page "/pad"
@using SyncPad.Client.Core.Services
@using SyncPad.Shared.Models
@inject IAuthManager AuthManager
@inject IApiClient ApiClient
@inject ITextHubClient TextHubClient
@inject IFileClient FileClient
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Èù¢Êùø - SyncPad</PageTitle>

<div class="pad-layout">
    <!-- Â∑¶‰æß‰∏ªÂå∫ÂüüÔºàÊñáÊú¨ÁºñËæëÔºâ -->
    <div class="text-area">
        <!-- È°∂ÈÉ®Â∑•ÂÖ∑Ê†è -->
        <div class="toolbar">
            <div class="user-info">
                <span>Áî®Êà∑: <strong>@AuthManager.Username</strong></span>
            </div>
            <div class="toolbar-actions">
                <button class="btn-secondary" @onclick="RefreshText">Âà∑Êñ∞</button>
                <button class="btn-danger" @onclick="Logout">ÁôªÂá∫</button>
            </div>
        </div>

        <!-- ÊñáÊú¨ÁºñËæëÂå∫Âüü -->
        <div class="editor-container">
            <textarea @bind="_content" @bind:event="oninput" @onkeyup="HandleTextChange" placeholder="Âú®ËøôÈáåËæìÂÖ•ÊñáÊú¨..."></textarea>
        </div>

        <!-- Áä∂ÊÄÅÊ†è -->
        <div class="status-bar">
            <div class="connection-status">
                <span class="status-indicator @(_isConnected ? "connected" : "disconnected")"></span>
                <span>@_connectionStatus</span>
            </div>
        </div>
    </div>

    <!-- Âè≥‰æßÊñá‰ª∂Âå∫Âüü -->
    <div class="file-area">
        <!-- Êñá‰ª∂Âå∫ÂüüÊ†áÈ¢òÊ†è -->
        <div class="file-header">
            <h3>Êñá‰ª∂ÂàóË°®</h3>
            <label class="btn-primary upload-btn">
                ‰∏ä‰º†
                <InputFile OnChange="HandleFileSelected" style="display: none;" />
            </label>
        </div>

        <!-- Êñá‰ª∂ÁΩëÊ†ºÔºàÁªùÂØπÂÆö‰ΩçÂ∏ÉÂ±ÄÔºâ -->
        <div class="file-grid"
             @ref="_fileGridRef"
             @onclick="OnFileGridClick"
             @ondragover="OnGridDragOver"
             @ondragover:preventDefault="true"
             @ondrop="OnGridDrop"
             @ondrop:preventDefault="true"
             @ondragleave="OnGridDragLeave">
            @if (_files.Count == 0)
            {
                <div class="empty-state">ÊöÇÊó†Êñá‰ª∂</div>
            }
            else
            {
                @foreach (var file in _files)
                {
                    <div class="file-card @(file.IsSelected ? "selected" : "") @(_draggedFile == file ? "dragging" : "")"
                         style="left: @(file.File.PositionX * 122 + 10)px; top: @(file.File.PositionY * 122 + 10)px;"
                         draggable="true"
                         @ondragstart="(e) => OnDragStart(e, file)"
                         @ondragend="OnDragEnd"
                         @onclick="(e) => HandleFileClick(e, file)"
                         @onclick:stopPropagation="true"
                         @ondblclick="() => DownloadFile(file)">
                        <div class="file-icon-container">
                            <div class="file-icon">@file.FileIcon</div>
                            @if (!string.IsNullOrEmpty(file.StatusBadge))
                            {
                                <div class="status-badge">@file.StatusBadge</div>
                            }
                        </div>
                        <div class="file-name" title="@file.File.FileName">@file.File.FileName</div>
                        <div class="file-meta">@file.FileSizeText ¬∑ @file.StatusText</div>
                        @if (file.ShowProgress)
                        {
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: @(file.DownloadProgress)%"></div>
                            </div>
                        }
                    </div>
                }
            }

            <!-- ÊãñÊîæ‰ΩçÁΩÆÊåáÁ§∫Âô® -->
            @if (_showDropIndicator)
            {
                <div class="drop-indicator" style="left: @(_dropIndicatorX)px; top: @(_dropIndicatorY)px;"></div>
            }
        </div>

        <!-- ÊâπÈáèÊìç‰ΩúÂ∑•ÂÖ∑Ê†è -->
        @if (SelectedFilesCount > 0)
        {
            <div class="batch-toolbar">
                <span class="batch-info">Â∑≤ÈÄâÊã© @SelectedFilesCount ‰∏™Êñá‰ª∂</span>
                <button class="btn-success btn-sm" @onclick="BatchDownload">ÊâπÈáè‰∏ãËΩΩ</button>
                <button class="btn-danger btn-sm" @onclick="BatchDelete">ÊâπÈáèÂà†Èô§</button>
                <button class="btn-secondary btn-sm" @onclick="ClearSelection">ÂèñÊ∂à</button>
            </div>
        }
    </div>
</div>

<style>
    .pad-layout {
        display: flex;
        height: 100vh;
        background-color: #f5f5f5;
    }

    .text-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #ddd;
    }

    .file-area {
        width: 520px;
        display: flex;
        flex-direction: column;
        background-color: white;
    }

    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        background-color: white;
        border-bottom: 1px solid #ddd;
    }

    .user-info {
        color: #666;
    }

    .toolbar-actions {
        display: flex;
        gap: 10px;
    }

    .btn-secondary, .btn-primary, .btn-success, .btn-danger {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background-color: #0069d9;
    }

    .btn-success {
        background-color: #28a745;
        color: white;
    }

    .btn-success:hover {
        background-color: #218838;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background-color: #c82333;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
    }

    .btn-icon {
        padding: 6px 10px;
        font-size: 16px;
    }

    .editor-container {
        flex: 1;
        padding: 20px;
    }

    .editor-container textarea {
        width: 100%;
        height: 100%;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        font-family: inherit;
        resize: none;
        box-sizing: border-box;
    }

    .editor-container textarea:focus {
        outline: none;
        border-color: #007bff;
    }

    .status-bar {
        padding: 10px 20px;
        background-color: white;
        border-top: 1px solid #ddd;
    }

    .connection-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #666;
    }

    .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }

    .status-indicator.connected {
        background-color: #28a745;
    }

    .status-indicator.disconnected {
        background-color: #dc3545;
    }

    .file-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background-color: #e9ecef;
        border-bottom: 1px solid #ddd;
    }

    .file-header h3 {
        margin: 0;
        font-size: 16px;
    }

    .upload-btn {
        cursor: pointer;
        margin: 0;
    }

    .file-grid {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        position: relative;
        min-height: 0;
        transition: background-color 0.2s;
    }

    .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 40px 20px;
        color: #999;
        font-size: 14px;
    }

    .file-card {
        position: absolute;
        width: 120px;
        height: 120px;
        background-color: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        padding: 8px;
        cursor: pointer;
        transition: all 0.1s;
        display: flex;
        flex-direction: column;
        gap: 4px;
        box-sizing: border-box;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }

    .file-card:hover {
        background-color: rgba(0, 120, 212, 0.08);
        border-color: rgba(0, 120, 212, 0.2);
    }

    .file-card.selected {
        background-color: rgba(0, 120, 212, 0.2);
        border-color: rgba(0, 120, 212, 0.5);
    }

    .file-card.selected:hover {
        background-color: rgba(0, 120, 212, 0.25);
        border-color: rgba(0, 120, 212, 0.6);
    }

    .file-card.dragging {
        opacity: 0.4;
    }

    /* ÊãñÊîæ‰ΩçÁΩÆÊåáÁ§∫Âô® */
    .drop-indicator {
        position: absolute;
        width: 120px;
        height: 120px;
        background-color: rgba(30, 144, 255, 0.3);
        border: 2px solid rgb(30, 144, 255);
        border-radius: 4px;
        pointer-events: none;
        z-index: 1000;
    }

    .file-icon-container {
        position: relative;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 4px;
    }

    .file-icon {
        font-size: 32px;
    }

    .status-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        font-size: 12px;
    }

    .file-name {
        font-size: 12px;
        font-weight: 600;
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-height: 1.4;
        height: 34px;
        word-break: break-all;
        min-width: 0;
    }

    .file-meta {
        font-size: 10px;
        color: #6c757d;
        text-align: center;
        height: 14px;
    }

    .progress-bar {
        height: 4px;
        background-color: #e9ecef;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 4px;
    }

    .progress-fill {
        height: 100%;
        background-color: #007bff;
        transition: width 0.3s ease;
    }

    .batch-toolbar {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px;
        background-color: #f8f9fa;
        border-top: 1px solid #ddd;
    }

    .batch-info {
        flex: 1;
        font-size: 12px;
        color: #666;
    }

    /* ÂìçÂ∫îÂºèËÆæËÆ° */
    @@media (max-width: 768px) {
        .pad-layout {
            flex-direction: column;
        }

        .text-area {
            border-right: none;
            border-bottom: 1px solid #ddd;
        }

        .file-area {
            width: 100%;
            flex: 1;
        }

        .file-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    /* Âπ≥ÊùøÂíåÂ∞èÂ±èÂπï */
    @@media (max-width: 1024px) and (min-width: 769px) {
        .file-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
</style>

@code {
    private string _content = string.Empty;
    private string _connectionStatus = "Êú™ËøûÊé•";
    private bool _isConnected = false;
    private bool _isUpdatingFromServer = false;
    private bool _isInitialized = false;
    private CancellationTokenSource? _throttleCts;
    private readonly object _throttleLock = new();

    // Êñá‰ª∂ÂàóË°®
    private List<SelectableFileItemWeb> _files = new();
    private int SelectedFilesCount => _files.Count(f => f.IsSelected);
    private int _lastSelectedIndex = -1;

    // ÊãñÊîæÁä∂ÊÄÅ
    private SelectableFileItemWeb? _draggedFile = null;
    private ElementReference _fileGridRef;
    private DotNetObjectReference<Pad>? _dotNetRef;

    // ÁΩëÊ†ºÊãñÊîæÊåáÁ§∫Âô®
    private bool _showDropIndicator = false;
    private int _dropIndicatorX = 0;
    private int _dropIndicatorY = 0;
    private const int CellWidth = 120;
    private const int CellHeight = 120;
    private const int CellSpacing = 2;
    private const int GridPadding = 10;

    protected override void OnInitialized()
    {
        // ËÆ¢ÈòÖ‰∫ã‰ª∂ÔºàÂè™ËÆ¢ÈòÖ‰∏ÄÊ¨°Ôºâ
        TextHubClient.ConnectionStateChanged += OnConnectionStateChanged;
        TextHubClient.TextUpdateReceived += OnTextUpdateReceived;
        TextHubClient.FileUpdateReceived += OnFileUpdateReceived;
        TextHubClient.FilePositionChanged += OnFilePositionChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_isInitialized)
        {
            _isInitialized = true;

            // ÂÖàÂ∞ùËØïÊÅ¢Â§ç‰ºöÔøΩÔøΩÔøΩÔºàÈúÄË¶Å JS ‰∫íÊìç‰ΩúÔºâ
            await AuthManager.TryRestoreSessionAsync();

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁôªÂΩï
            if (!AuthManager.IsLoggedIn)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            // ÂàùÂßãÂåñÊãñÊîæÂå∫ÂüüÁöÑ JS ‰∫íÊìç‰Ωú
            _dotNetRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("DragDropInterop.initDropZone", _fileGridRef, _dotNetRef);

            // ËøûÊé• SignalR
            await ConnectToHub();

            // Âä†ËΩΩÂàùÂßãÊñáÊú¨
            await RefreshText();

            // Âä†ËΩΩÊñá‰ª∂ÂàóË°®
            await RefreshFiles();
        }
    }

    private async Task ConnectToHub()
    {
        try
        {
            _connectionStatus = "ËøûÊé•‰∏≠...";
            StateHasChanged();

            var hubUrl = AuthManager.GetHubUrl();
            var token = AuthManager.Token;

            if (!string.IsNullOrEmpty(token))
            {
                await TextHubClient.ConnectAsync(hubUrl, token);
            }
        }
        catch (Exception ex)
        {
            _connectionStatus = $"ËøûÊé•Â§±Ë¥•: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task RefreshText()
    {
        try
        {
            var response = await ApiClient.GetTextAsync();
            if (response.Success && response.Data != null)
            {
                _isUpdatingFromServer = true;
                _content = response.Data.Content;
                _isUpdatingFromServer = false;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Âà∑Êñ∞ÊñáÊú¨Â§±Ë¥•: {ex.Message}");
        }
    }

    private async Task RefreshFiles()
    {
        try
        {
            var response = await FileClient.GetFilesAsync();
            if (response.Success && response.Data != null)
            {
                _files = response.Data.Files.Select(f => new SelectableFileItemWeb(f)).ToList();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Âà∑Êñ∞Êñá‰ª∂ÂàóË°®Â§±Ë¥•: {ex.Message}");
        }
    }

    private void HandleTextChange()
    {
        if (!_isUpdatingFromServer)
        {
            ThrottleSendUpdate();
        }
    }

    private void ThrottleSendUpdate()
    {
        lock (_throttleLock)
        {
            _throttleCts?.Cancel();
            _throttleCts = new CancellationTokenSource();
            var token = _throttleCts.Token;
            var currentContent = _content;

            Task.Delay(300, token).ContinueWith(async _ =>
            {
                if (!token.IsCancellationRequested && TextHubClient.IsConnected)
                {
                    await TextHubClient.SendTextUpdateAsync(currentContent);
                }
            }, TaskContinuationOptions.OnlyOnRanToCompletion);
        }
    }

    private void OnConnectionStateChanged(bool connected)
    {
        InvokeAsync(() =>
        {
            _isConnected = connected;
            _connectionStatus = connected ? "Â∑≤ËøûÊé•" : "Â∑≤Êñ≠ÂºÄ";
            StateHasChanged();
        });
    }

    private void OnTextUpdateReceived(TextSyncMessage message)
    {
        InvokeAsync(() =>
        {
            _isUpdatingFromServer = true;
            _content = message.Content;
            _isUpdatingFromServer = false;
            StateHasChanged();
        });
    }

    private void OnFileUpdateReceived(FileSyncMessage message)
    {
        InvokeAsync(() =>
        {
            switch (message.Action)
            {
                case "added":
                    if (message.File != null)
                    {
                        var existing = _files.FirstOrDefault(f => f.File.FileName == message.File.FileName);
                        if (existing != null)
                            _files.Remove(existing);

                        _files.Insert(0, new SelectableFileItemWeb(message.File));
                    }
                    break;

                case "deleted":
                    if (message.FileId.HasValue)
                    {
                        var toRemove = _files.FirstOrDefault(f => f.File.Id == message.FileId.Value);
                        if (toRemove != null)
                            _files.Remove(toRemove);
                    }
                    break;
            }

            StateHasChanged();
        });
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            await UploadFile(file);
        }
    }

    private async Task UploadFile(Microsoft.AspNetCore.Components.Forms.IBrowserFile file)
    {
        try
        {
            // Ê£ÄÊü•ÂêåÂêçÊñá‰ª∂
            if (await FileClient.FileExistsAsync(file.Name))
            {
                // Web ÁéØÂ¢É‰∏ã‰ΩøÁî® JS Interop Êù•ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
                // ËøôÈáåÁÆÄÂåñÂ§ÑÁêÜÔºåÁõ¥Êé•Ë¶ÜÁõñ
                using var stream = file.OpenReadStream(maxAllowedSize: 100 * 1024 * 1024);
                await FileClient.UploadFileAsync(file.Name, stream, file.ContentType, overwrite: true);
            }
            else
            {
                using var stream = file.OpenReadStream(maxAllowedSize: 100 * 1024 * 1024);
                var response = await FileClient.UploadFileAsync(file.Name, stream, file.ContentType);

                if (!response.Success)
                {
                    Console.WriteLine($"‰∏ä‰º†Â§±Ë¥•: {response.ErrorMessage}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‰∏ä‰º†Êñá‰ª∂Â§±Ë¥•: {ex.Message}");
        }
    }

    private void HandleFileClick(Microsoft.AspNetCore.Components.Web.MouseEventArgs e, SelectableFileItemWeb file)
    {
        var currentIndex = _files.IndexOf(file);

        if (e.CtrlKey)
        {
            // Ctrl + ÂçïÂáªÔºöÂàáÊç¢ÈÄâ‰∏≠Áä∂ÊÄÅ
            file.IsSelected = !file.IsSelected;
            _lastSelectedIndex = file.IsSelected ? currentIndex : -1;
        }
        else if (e.ShiftKey && _lastSelectedIndex >= 0)
        {
            // Shift + ÂçïÂáªÔºöËåÉÂõ¥ÈÄâÊã©
            var startIndex = Math.Min(_lastSelectedIndex, currentIndex);
            var endIndex = Math.Max(_lastSelectedIndex, currentIndex);

            for (int i = startIndex; i <= endIndex; i++)
            {
                _files[i].IsSelected = true;
            }
        }
        else
        {
            // ÊôÆÈÄöÂçïÂáªÔºöÊ∏ÖÈô§ÂÖ∂‰ªñÈÄâÊã©Ôºå‰ªÖÈÄâ‰∏≠ÂΩìÂâç
            foreach (var f in _files)
            {
                f.IsSelected = false;
            }
            file.IsSelected = true;
            _lastSelectedIndex = currentIndex;
        }

        StateHasChanged();
    }

    private void DownloadFile(SelectableFileItemWeb file)
    {
        var url = FileClient.GetDownloadUrl(file.File.Id);
        Navigation.NavigateTo(url, true);
    }

    private async Task DeleteFile(SelectableFileItemWeb file)
    {
        // ÁÆÄÂåñÂ§ÑÁêÜÔºåÁõ¥Êé•Âà†Èô§
        try
        {
            var response = await FileClient.DeleteFileAsync(file.File.Id);
            if (!response.Success)
            {
                Console.WriteLine($"Âà†Èô§Â§±Ë¥•: {response.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Âà†Èô§Êñá‰ª∂Â§±Ë¥•: {ex.Message}");
        }
    }

    private void OnFileSelectionChanged()
    {
        StateHasChanged();
    }

    private void ToggleSelection(SelectableFileItemWeb file)
    {
        file.IsSelected = !file.IsSelected;
        StateHasChanged();
    }

    private void ClearSelection()
    {
        foreach (var file in _files)
        {
            file.IsSelected = false;
        }
        StateHasChanged();
    }

    // ÁÇπÂáªÁ©∫ÁôΩÂå∫ÂüüÂèñÊ∂àÈÄâ‰∏≠
    private void OnFileGridClick(Microsoft.AspNetCore.Components.Web.MouseEventArgs e)
    {
        // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÁ©∫ÁôΩÂå∫ÂüüÔºà‰∏çÊòØÊñá‰ª∂Âç°ÁâáÔºâÔºåÂèñÊ∂àÊâÄÊúâÈÄâ‰∏≠
        ClearSelection();
    }

    // ÂÜÖÈÉ®ÊãñÊîæ‰∫ã‰ª∂Â§ÑÁêÜ
    private void OnDragStart(Microsoft.AspNetCore.Components.Web.DragEventArgs e, SelectableFileItemWeb file)
    {
        _draggedFile = file;
        StateHasChanged();
    }

    private void OnGridDragOver(Microsoft.AspNetCore.Components.Web.DragEventArgs e)
    {
        try
        {
            if (_draggedFile == null)
                return;

            // ËÆ°ÁÆóÁΩëÊ†º‰ΩçÁΩÆ
            var gridPos = CalculateGridPosition(e.OffsetX, e.OffsetY);

            // Êõ¥Êñ∞ÊåáÁ§∫Âô®‰ΩçÁΩÆ
            _showDropIndicator = true;
            _dropIndicatorX = gridPos.X * (CellWidth + CellSpacing) + GridPadding;
            _dropIndicatorY = gridPos.Y * (CellHeight + CellSpacing) + GridPadding;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"OnGridDragOver ÈîôËØØ: {ex.Message}");
        }
    }

    private void OnGridDragLeave()
    {
        _showDropIndicator = false;
        StateHasChanged();
    }

    private async Task OnGridDrop(Microsoft.AspNetCore.Components.Web.DragEventArgs e)
    {
        _showDropIndicator = false;

        // ‰øùÂ≠òÊãñÂä®ÁöÑÊñá‰ª∂ÂºïÁî®ÔºàÂõ†‰∏∫ finally ‰ºöÊ∏ÖÁ©∫ÂÆÉÔºâ
        var draggedFile = _draggedFile;

        try
        {
            if (draggedFile == null)
            {
                Console.WriteLine("OnGridDrop: _draggedFile ‰∏∫ null");
                return;
            }

            Console.WriteLine($"OnGridDrop: ÊãñÊîæ‰∫ã‰ª∂Ëß¶ÂèëÔºåOffsetX={e.OffsetX}, OffsetY={e.OffsetY}");
            Console.WriteLine($"OnGridDrop: ÊãñÂä®Êñá‰ª∂={draggedFile.File?.FileName ?? "null"}");

            // Ê£ÄÊü• File ÂØπË±°
            if (draggedFile.File == null)
            {
                Console.WriteLine("OnGridDrop: draggedFile.File ‰∏∫ null");
                return;
            }

            // ËÆ°ÁÆóÁõÆÊ†áÁΩëÊ†º‰ΩçÁΩÆ
            var gridPos = CalculateGridPosition(e.OffsetX, e.OffsetY);
            Console.WriteLine($"OnGridDrop: ËÆ°ÁÆóÁöÑÁΩëÊ†º‰ΩçÁΩÆ=({gridPos.X}, {gridPos.Y})");

            // Ê£ÄÊü• TextHubClient ÊòØÂê¶‰∏∫ null
            if (TextHubClient == null)
            {
                Console.WriteLine("OnGridDrop: TextHubClient ‰∏∫ null");
                return;
            }

            // Êõ¥Êñ∞Êñá‰ª∂‰ΩçÁΩÆ
            Console.WriteLine($"OnGridDrop: ÂáÜÂ§áË∞ÉÁî® UpdateFilePositionAsync, FileId={draggedFile.File.Id}");
            await TextHubClient.UpdateFilePositionAsync(draggedFile.File.Id, gridPos.X, gridPos.Y);
            Console.WriteLine($"OnGridDrop: Êñá‰ª∂ {draggedFile.File.FileName} Â∑≤ÁßªÂä®Âà∞ ({gridPos.X}, {gridPos.Y})");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"OnGridDrop ÈîôËØØ: {ex.Message}");
            Console.WriteLine($"InnerException: {ex.InnerException?.Message}");
            Console.WriteLine($"StackTrace: {ex.StackTrace}");
        }
        finally
        {
            _draggedFile = null;
            StateHasChanged();
        }
    }

    private void OnDragEnd()
    {
        _draggedFile = null;
        _showDropIndicator = false;
        StateHasChanged();
    }

    /// <summary>
    /// ËÆ°ÁÆóÁΩëÊ†ºÂùêÊ†á
    /// </summary>
    private (int X, int Y) CalculateGridPosition(double offsetX, double offsetY)
    {
        const int columns = 4;

        // ÂáèÂéª padding
        double x = offsetX - GridPadding;
        double y = offsetY - GridPadding;

        // ËÆ°ÁÆóÁΩëÊ†º‰ΩçÁΩÆ
        int column = (int)(x / (CellWidth + CellSpacing));
        int row = (int)(y / (CellHeight + CellSpacing));

        // ÈôêÂà∂ÂàóËåÉÂõ¥
        if (column < 0) column = 0;
        if (column >= columns) column = columns - 1;
        if (row < 0) row = 0;

        return (column, row);
    }

    // JS ‰∫íÊìç‰ΩúÂõûË∞ÉÔºöÂ§ñÈÉ®Êñá‰ª∂ÊãñÂÖ•
    [JSInvokable]
    public async Task OnFilesDropped(FileDropInfo[] files)
    {
        if (files == null || files.Length == 0)
            return;

        for (int i = 0; i < files.Length; i++)
        {
            try
            {
                // ÈÄöËøá JS ËØªÂèñÊñá‰ª∂ÂÜÖÂÆπ
                var fileData = await JSRuntime.InvokeAsync<FileDataInfo>("DragDropInterop.readDroppedFile", i);
                if (fileData != null)
                {
                    // Â∞Ü base64 ËΩ¨Êç¢‰∏∫Â≠óËäÇÊï∞ÁªÑ
                    var bytes = Convert.FromBase64String(fileData.Data);
                    using var stream = new MemoryStream(bytes);

                    // Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®ÂêåÂêçÊñá‰ª∂
                    bool overwrite = await FileClient.FileExistsAsync(fileData.Name);

                    // ‰∏ä‰º†Êñá‰ª∂
                    await FileClient.UploadFileAsync(fileData.Name, stream, fileData.Type, overwrite);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"‰∏ä‰º†Êñá‰ª∂Â§±Ë¥•: {ex.Message}");
            }
        }

        // Ê∏ÖÁêÜÊöÇÂ≠òÁöÑÊñá‰ª∂
        await JSRuntime.InvokeVoidAsync("DragDropInterop.clearDroppedFiles");
    }

    // JS ‰∫íÊìç‰ΩúÁî®ÁöÑÊï∞ÊçÆÁ±ª
    public class FileDropInfo
    {
        public string Name { get; set; } = string.Empty;
        public long Size { get; set; }
        public string Type { get; set; } = string.Empty;
    }

    public class FileDataInfo
    {
        public string Name { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
        public long Size { get; set; }
        public string Data { get; set; } = string.Empty;
    }

    private void OnFilePositionChanged(int fileId, int positionX, int positionY)
    {
        InvokeAsync(() =>
        {
            var file = _files.FirstOrDefault(f => f.File.Id == fileId);
            if (file != null)
            {
                // ÈáçÊñ∞ÂàõÂª∫Êñá‰ª∂È°π‰ª•Êõ¥Êñ∞‰ΩçÁΩÆ
                var index = _files.IndexOf(file);
                if (index >= 0)
                {
                    var updatedDto = new FileItemDto
                    {
                        Id = file.File.Id,
                        FileName = file.File.FileName,
                        FileSize = file.File.FileSize,
                        MimeType = file.File.MimeType,
                        UploadedAt = file.File.UploadedAt,
                        ExpiresAt = file.File.ExpiresAt,
                        PositionX = positionX,
                        PositionY = positionY
                    };

                    var updatedItem = new SelectableFileItemWeb(updatedDto)
                    {
                        Status = file.Status,
                        DownloadProgress = file.DownloadProgress,
                        IsSelected = file.IsSelected
                    };

                    _files[index] = updatedItem;
                }
            }
            StateHasChanged();
        });
    }

    private void BatchDownload()
    {
        foreach (var file in _files.Where(f => f.IsSelected))
        {
            DownloadFile(file);
        }
    }

    private async Task BatchDelete()
    {
        var filesToDelete = _files.Where(f => f.IsSelected).ToList();
        foreach (var file in filesToDelete)
        {
            await DeleteFile(file);
        }
        ClearSelection();
    }

    private async Task Logout()
    {
        await TextHubClient.DisconnectAsync();
        await AuthManager.LogoutAsync();
        Navigation.NavigateTo("/login");
    }

    public void Dispose()
    {
        TextHubClient.ConnectionStateChanged -= OnConnectionStateChanged;
        TextHubClient.TextUpdateReceived -= OnTextUpdateReceived;
        TextHubClient.FileUpdateReceived -= OnFileUpdateReceived;
        TextHubClient.FilePositionChanged -= OnFilePositionChanged;
        _throttleCts?.Cancel();
        _throttleCts?.Dispose();
        _dotNetRef?.Dispose();
    }

    // Web ‰∏ìÁî®ÁöÑÂèØÈÄâÊã©Êñá‰ª∂È°π
    private class SelectableFileItemWeb
    {
        public FileItemDto File { get; }
        public bool IsSelected { get; set; }
        public FileStatus Status { get; set; } = FileStatus.Remote;
        public int DownloadProgress { get; set; }

        // UI ËæÖÂä©Â±ûÊÄß
        public string StatusText => Status switch
        {
            FileStatus.Remote => "‰∫ëÁ´Ø",
            FileStatus.PreloadPending => "ÈòüÂàó‰∏≠",
            FileStatus.Preloading => $"È¢ÑËΩΩ‰∏≠ {DownloadProgress}%",
            FileStatus.Cached => "Â∑≤ÁºìÂ≠ò",
            _ => "Êú™Áü•"
        };

        public bool ShowProgress => Status == FileStatus.Preloading;

        public string FileIcon => GetFileIcon(File.MimeType);

        public string StatusBadge => Status switch
        {
            FileStatus.Remote => "‚òÅÔ∏è",
            FileStatus.PreloadPending => "üïê",
            FileStatus.Cached => "‚úì",
            _ => ""
        };

        public string FileSizeText => FormatFileSize(File.FileSize);

        public SelectableFileItemWeb(FileItemDto file)
        {
            File = file;
        }

        private string GetFileIcon(string? mimeType)
        {
            if (string.IsNullOrEmpty(mimeType))
                return "üìé";

            return mimeType switch
            {
                _ when mimeType.StartsWith("image/") => "üì∑",
                _ when mimeType.StartsWith("video/") => "üé¨",
                _ when mimeType.StartsWith("audio/") => "üéµ",
                "application/pdf" => "üìÑ",
                "application/msword" => "üìÑ",
                "application/vnd.openxmlformats-officedocument.wordprocessingml.document" => "üìÑ",
                "text/plain" => "üìÑ",
                "application/zip" => "üì¶",
                "application/x-rar-compressed" => "üì¶",
                "application/x-7z-compressed" => "üì¶",
                "application/x-tar" => "üì¶",
                "text/html" => "üíª",
                "text/css" => "üíª",
                "application/javascript" => "üíª",
                "text/javascript" => "üíª",
                "application/json" => "üíª",
                "application/xml" => "üíª",
                _ when mimeType.Contains("csharp") => "üíª",
                _ when mimeType.Contains("python") => "üíª",
                _ when mimeType.Contains("java") => "üíª",
                _ => "üìé"
            };
        }

        private string FormatFileSize(long bytes)
        {
            string[] sizes = { "B", "KB", "MB", "GB" };
            double len = bytes;
            int order = 0;
            while (len >= 1024 && order < sizes.Length - 1)
            {
                order++;
                len = len / 1024;
            }
            return $"{len:0.#} {sizes[order]}";
        }
    }
}
