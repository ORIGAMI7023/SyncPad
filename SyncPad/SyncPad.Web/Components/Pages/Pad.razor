@page "/pad"
@using SyncPad.Client.Core.Services
@using SyncPad.Shared.Models
@inject IAuthManager AuthManager
@inject IApiClient ApiClient
@inject ITextHubClient TextHubClient
@inject IFileClient FileClient
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Èù¢Êùø - SyncPad</PageTitle>

<div class="pad-layout">
    <!-- Â∑¶‰æß‰∏ªÂå∫ÂüüÔºàÊñáÊú¨ÁºñËæëÔºâ -->
    <div class="text-area">
        <!-- È°∂ÈÉ®Â∑•ÂÖ∑Ê†è -->
        <div class="toolbar">
            <div class="user-info">
                <span>Áî®Êà∑: <strong>@AuthManager.Username</strong></span>
            </div>
            <div class="toolbar-actions">
                <button class="btn-secondary" @onclick="RefreshText">Âà∑Êñ∞</button>
                <button class="btn-danger" @onclick="Logout">ÁôªÂá∫</button>
            </div>
        </div>

        <!-- ÊñáÊú¨ÁºñËæëÂå∫Âüü -->
        <div class="editor-container">
            <textarea @bind="_content" @bind:event="oninput" @onkeyup="HandleTextChange" placeholder="Âú®ËøôÈáåËæìÂÖ•ÊñáÊú¨..."></textarea>
        </div>

        <!-- Áä∂ÊÄÅÊ†è -->
        <div class="status-bar">
            <div class="connection-status">
                <span class="status-indicator @(_isConnected ? "connected" : "disconnected")"></span>
                <span>@_connectionStatus</span>
            </div>
        </div>
    </div>

    <!-- Âè≥‰æßÊñá‰ª∂Âå∫Âüü -->
    <div class="file-area">
        <!-- Êñá‰ª∂Âå∫ÂüüÊ†áÈ¢òÊ†è -->
        <div class="file-header">
            <h3>Êñá‰ª∂ÂàóË°®</h3>
            <label class="btn-primary upload-btn">
                ‰∏ä‰º†
                <InputFile OnChange="HandleFileSelected" style="display: none;" />
            </label>
        </div>

        <!-- Êñá‰ª∂ÂàóË°® -->
        <div class="file-list">
            @if (_files.Count == 0)
            {
                <div class="empty-state">ÊöÇÊó†Êñá‰ª∂</div>
            }
            else
            {
                @foreach (var file in _files)
                {
                    <div class="file-item">
                        <input type="checkbox" @bind="file.IsSelected" @onclick="() => OnFileSelectionChanged()" />
                        <div class="file-info">
                            <div class="file-name">@file.File.FileName</div>
                            <div class="file-meta">
                                @file.File.FileSize.ToString("N0") Â≠óËäÇ ¬∑ @file.File.UploadedAt.ToString("yyyy-MM-dd HH:mm")
                            </div>
                        </div>
                        <button class="btn-success btn-icon" @onclick="() => DownloadFile(file)" title="‰∏ãËΩΩ">üì•</button>
                        <button class="btn-danger btn-icon" @onclick="() => DeleteFile(file)" title="Âà†Èô§">üóë</button>
                    </div>
                }
            }
        </div>

        <!-- ÊâπÈáèÊìç‰ΩúÂ∑•ÂÖ∑Ê†è -->
        @if (SelectedFilesCount > 0)
        {
            <div class="batch-toolbar">
                <span class="batch-info">Â∑≤ÈÄâÊã© @SelectedFilesCount ‰∏™Êñá‰ª∂</span>
                <button class="btn-success btn-sm" @onclick="BatchDownload">ÊâπÈáè‰∏ãËΩΩ</button>
                <button class="btn-danger btn-sm" @onclick="BatchDelete">ÊâπÈáèÂà†Èô§</button>
                <button class="btn-secondary btn-sm" @onclick="ClearSelection">ÂèñÊ∂à</button>
            </div>
        }
    </div>
</div>

<style>
    .pad-layout {
        display: flex;
        height: 100vh;
        background-color: #f5f5f5;
    }

    .text-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #ddd;
    }

    .file-area {
        width: 350px;
        display: flex;
        flex-direction: column;
        background-color: white;
    }

    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        background-color: white;
        border-bottom: 1px solid #ddd;
    }

    .user-info {
        color: #666;
    }

    .toolbar-actions {
        display: flex;
        gap: 10px;
    }

    .btn-secondary, .btn-primary, .btn-success, .btn-danger {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background-color: #0069d9;
    }

    .btn-success {
        background-color: #28a745;
        color: white;
    }

    .btn-success:hover {
        background-color: #218838;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background-color: #c82333;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
    }

    .btn-icon {
        padding: 6px 10px;
        font-size: 16px;
    }

    .editor-container {
        flex: 1;
        padding: 20px;
    }

    .editor-container textarea {
        width: 100%;
        height: 100%;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
        font-family: inherit;
        resize: none;
        box-sizing: border-box;
    }

    .editor-container textarea:focus {
        outline: none;
        border-color: #007bff;
    }

    .status-bar {
        padding: 10px 20px;
        background-color: white;
        border-top: 1px solid #ddd;
    }

    .connection-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #666;
    }

    .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }

    .status-indicator.connected {
        background-color: #28a745;
    }

    .status-indicator.disconnected {
        background-color: #dc3545;
    }

    .file-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background-color: #e9ecef;
        border-bottom: 1px solid #ddd;
    }

    .file-header h3 {
        margin: 0;
        font-size: 16px;
    }

    .upload-btn {
        cursor: pointer;
        margin: 0;
    }

    .file-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
        font-size: 14px;
    }

    .file-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
    }

    .file-item:hover {
        background-color: #f8f9fa;
    }

    .file-item input[type="checkbox"] {
        flex-shrink: 0;
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .file-info {
        flex: 1;
        min-width: 0;
    }

    .file-name {
        font-size: 14px;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .file-meta {
        font-size: 11px;
        color: #999;
        margin-top: 4px;
    }

    .batch-toolbar {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px;
        background-color: #f8f9fa;
        border-top: 1px solid #ddd;
    }

    .batch-info {
        flex: 1;
        font-size: 12px;
        color: #666;
    }

    /* ÂìçÂ∫îÂºèËÆæËÆ° */
    @@media (max-width: 768px) {
        .pad-layout {
            flex-direction: column;
        }

        .text-area {
            border-right: none;
            border-bottom: 1px solid #ddd;
        }

        .file-area {
            width: 100%;
            flex: 1;
        }
    }
</style>

@code {
    private string _content = string.Empty;
    private string _connectionStatus = "Êú™ËøûÊé•";
    private bool _isConnected = false;
    private bool _isUpdatingFromServer = false;
    private bool _isInitialized = false;
    private CancellationTokenSource? _throttleCts;
    private readonly object _throttleLock = new();

    // Êñá‰ª∂ÂàóË°®
    private List<SelectableFileItemWeb> _files = new();
    private int SelectedFilesCount => _files.Count(f => f.IsSelected);

    protected override void OnInitialized()
    {
        // ËÆ¢ÈòÖ‰∫ã‰ª∂ÔºàÂè™ËÆ¢ÈòÖ‰∏ÄÊ¨°Ôºâ
        TextHubClient.ConnectionStateChanged += OnConnectionStateChanged;
        TextHubClient.TextUpdateReceived += OnTextUpdateReceived;
        TextHubClient.FileUpdateReceived += OnFileUpdateReceived;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_isInitialized)
        {
            _isInitialized = true;

            // ÂÖàÂ∞ùËØïÊÅ¢Â§ç‰ºöËØùÔºàÈúÄË¶Å JS ‰∫íÊìç‰ΩúÔºâ
            await AuthManager.TryRestoreSessionAsync();

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁôªÂΩï
            if (!AuthManager.IsLoggedIn)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            // ËøûÊé• SignalR
            await ConnectToHub();

            // Âä†ËΩΩÂàùÂßãÊñáÊú¨
            await RefreshText();

            // Âä†ËΩΩÊñá‰ª∂ÂàóË°®
            await RefreshFiles();
        }
    }

    private async Task ConnectToHub()
    {
        try
        {
            _connectionStatus = "ËøûÊé•‰∏≠...";
            StateHasChanged();

            var hubUrl = AuthManager.GetHubUrl();
            var token = AuthManager.Token;

            if (!string.IsNullOrEmpty(token))
            {
                await TextHubClient.ConnectAsync(hubUrl, token);
            }
        }
        catch (Exception ex)
        {
            _connectionStatus = $"ËøûÊé•Â§±Ë¥•: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task RefreshText()
    {
        try
        {
            var response = await ApiClient.GetTextAsync();
            if (response.Success && response.Data != null)
            {
                _isUpdatingFromServer = true;
                _content = response.Data.Content;
                _isUpdatingFromServer = false;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Âà∑Êñ∞ÊñáÊú¨Â§±Ë¥•: {ex.Message}");
        }
    }

    private async Task RefreshFiles()
    {
        try
        {
            var response = await FileClient.GetFilesAsync();
            if (response.Success && response.Data != null)
            {
                _files = response.Data.Files.Select(f => new SelectableFileItemWeb(f)).ToList();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Âà∑Êñ∞Êñá‰ª∂ÂàóË°®Â§±Ë¥•: {ex.Message}");
        }
    }

    private void HandleTextChange()
    {
        if (!_isUpdatingFromServer)
        {
            ThrottleSendUpdate();
        }
    }

    private void ThrottleSendUpdate()
    {
        lock (_throttleLock)
        {
            _throttleCts?.Cancel();
            _throttleCts = new CancellationTokenSource();
            var token = _throttleCts.Token;
            var currentContent = _content;

            Task.Delay(300, token).ContinueWith(async _ =>
            {
                if (!token.IsCancellationRequested && TextHubClient.IsConnected)
                {
                    await TextHubClient.SendTextUpdateAsync(currentContent);
                }
            }, TaskContinuationOptions.OnlyOnRanToCompletion);
        }
    }

    private void OnConnectionStateChanged(bool connected)
    {
        InvokeAsync(() =>
        {
            _isConnected = connected;
            _connectionStatus = connected ? "Â∑≤ËøûÊé•" : "Â∑≤Êñ≠ÂºÄ";
            StateHasChanged();
        });
    }

    private void OnTextUpdateReceived(TextSyncMessage message)
    {
        InvokeAsync(() =>
        {
            _isUpdatingFromServer = true;
            _content = message.Content;
            _isUpdatingFromServer = false;
            StateHasChanged();
        });
    }

    private void OnFileUpdateReceived(FileSyncMessage message)
    {
        InvokeAsync(() =>
        {
            switch (message.Action)
            {
                case "added":
                    if (message.File != null)
                    {
                        var existing = _files.FirstOrDefault(f => f.File.FileName == message.File.FileName);
                        if (existing != null)
                            _files.Remove(existing);

                        _files.Insert(0, new SelectableFileItemWeb(message.File));
                    }
                    break;

                case "deleted":
                    if (message.FileId.HasValue)
                    {
                        var toRemove = _files.FirstOrDefault(f => f.File.Id == message.FileId.Value);
                        if (toRemove != null)
                            _files.Remove(toRemove);
                    }
                    break;
            }

            StateHasChanged();
        });
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            await UploadFile(file);
        }
    }

    private async Task UploadFile(Microsoft.AspNetCore.Components.Forms.IBrowserFile file)
    {
        try
        {
            // Ê£ÄÊü•ÂêåÂêçÊñá‰ª∂
            if (await FileClient.FileExistsAsync(file.Name))
            {
                // Web ÁéØÂ¢É‰∏ã‰ΩøÁî® JS Interop Êù•ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
                // ËøôÈáåÁÆÄÂåñÂ§ÑÁêÜÔºåÁõ¥Êé•Ë¶ÜÁõñ
                using var stream = file.OpenReadStream(maxAllowedSize: 100 * 1024 * 1024);
                await FileClient.UploadFileAsync(file.Name, stream, file.ContentType, overwrite: true);
            }
            else
            {
                using var stream = file.OpenReadStream(maxAllowedSize: 100 * 1024 * 1024);
                var response = await FileClient.UploadFileAsync(file.Name, stream, file.ContentType);

                if (!response.Success)
                {
                    Console.WriteLine($"‰∏ä‰º†Â§±Ë¥•: {response.ErrorMessage}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‰∏ä‰º†Êñá‰ª∂Â§±Ë¥•: {ex.Message}");
        }
    }

    private void DownloadFile(SelectableFileItemWeb file)
    {
        var url = FileClient.GetDownloadUrl(file.File.Id);
        Navigation.NavigateTo(url, true);
    }

    private async Task DeleteFile(SelectableFileItemWeb file)
    {
        // ÁÆÄÂåñÂ§ÑÁêÜÔºåÁõ¥Êé•Âà†Èô§
        try
        {
            var response = await FileClient.DeleteFileAsync(file.File.Id);
            if (!response.Success)
            {
                Console.WriteLine($"Âà†Èô§Â§±Ë¥•: {response.ErrorMessage}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Âà†Èô§Êñá‰ª∂Â§±Ë¥•: {ex.Message}");
        }
    }

    private void OnFileSelectionChanged()
    {
        StateHasChanged();
    }

    private void ClearSelection()
    {
        foreach (var file in _files)
        {
            file.IsSelected = false;
        }
        StateHasChanged();
    }

    private void BatchDownload()
    {
        foreach (var file in _files.Where(f => f.IsSelected))
        {
            DownloadFile(file);
        }
    }

    private async Task BatchDelete()
    {
        var filesToDelete = _files.Where(f => f.IsSelected).ToList();
        foreach (var file in filesToDelete)
        {
            await DeleteFile(file);
        }
        ClearSelection();
    }

    private async Task Logout()
    {
        await TextHubClient.DisconnectAsync();
        await AuthManager.LogoutAsync();
        Navigation.NavigateTo("/login");
    }

    public void Dispose()
    {
        TextHubClient.ConnectionStateChanged -= OnConnectionStateChanged;
        TextHubClient.TextUpdateReceived -= OnTextUpdateReceived;
        TextHubClient.FileUpdateReceived -= OnFileUpdateReceived;
        _throttleCts?.Cancel();
        _throttleCts?.Dispose();
    }

    // Web ‰∏ìÁî®ÁöÑÂèØÈÄâÊã©Êñá‰ª∂È°π
    private class SelectableFileItemWeb
    {
        public FileItemDto File { get; }
        public bool IsSelected { get; set; }

        public SelectableFileItemWeb(FileItemDto file)
        {
            File = file;
        }
    }
}
