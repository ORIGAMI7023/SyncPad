# SyncPad 开发文档 v1

> 版本：v1（需求/架构初稿）  
> 范围：基于当前所有对话中已确认的设计与约束

---

## 1. 项目概述

**SyncPad** 是一个跨平台的“实时共享面板”工具，用于在多设备之间共享：

- 一个实时同步的**文本区域**（类似 VS Code 的编辑区域简化版）
- 一个**文件区域**（显示共享文件的列表/图标）

核心特点：

- 中心服务器架构（非 P2P），所有客户端连接同一服务端
- **文本强实时**：输入后其他端几乎即时看到
- **文件弱实时**：图标和文件列表实时同步，文件内容按需预载/下载
- 支持桌面（Windows/macOS）常驻后台使用；移动端（iOS/Android）按系统生命周期运行

> 设计定位：**临时协作工具 / 个人和小团队的共享面板**，不是长期网盘。

---

## 2. 目标与非目标

### 2.1 目标

1. 在多设备之间快速共享文本和文件：
   - Windows / macOS / iOS / Android
2. 文本编辑实时同步，体验接近聊天/协作编辑（但不做复杂 CRDT）
3. 文件列表/状态实时同步，文件内容按需下载
4. 服务器只做**短期缓存**，不演化为长期网盘
5. 提供基础账号体系：登录、注册、修改密码
6. 提供清晰的日志与可测试的核心逻辑

### 2.2 非目标（目前阶段）

- 不做：
  - CRDT 多光标协作编辑
  - 长期文件归档/版本历史
  - 精细权限控制（只读/可写、团队管理等）
- 不做：
  - OS 级文件系统接管、伪文件、占位文件等“取巧”行为
  - P2P / NAT 打洞等 Syncthing 类能力

---

## 3. 平台与技术栈

### 3.1 客户端

#### 3.1.1 原生客户端（.NET MAUI）

- **Windows**：MAUI 原生窗口 + 托盘常驻
- **macOS**：MAUI 原生窗口（关闭按钮只关窗不退进程）
- **iOS / Android**：MAUI 原生 App，遵守移动端生命周期（不强求后台常驻）

UI 控件：
- 文本框：MAUI 原生多行文本控件（支持复制/粘贴，格式简单）
- 文件区：自定义列表视图，展示文件图标、名称、大小、状态

#### 3.1.2 网站客户端（Blazor Web）

- **SyncPad.Web**：Blazor WebAssembly 或 Blazor Server
- 运行于浏览器，无需安装
- 复用 `SyncPad.Client.Core` 和 `SyncPad.Shared`
- UI 逻辑与 MAUI 客户端保持一致
- 适用于临时访问、无法安装客户端的场景

### 3.2 服务端

- **ASP.NET Core** Web API
- **SignalR** 用于实时状态同步（文本、文件元信息、网络状态）
- 文件传输：HTTP(S) 上传/下载
- 数据存储：关系型数据库（可从 SQLite / SQL Server 起步），外加文件存储目录

### 3.3 服务端持久化要求（硬性要求）

> **重要**：以下为硬性设计约束，不允许使用内存缓存替代持久化存储。

即使所有客户端都离线，服务器必须完整保留以下数据：

| 数据类型 | 是否必须保留 | 存储位置 | 说明 |
|---------|------------|---------|------|
| 文本内容 | ✅ 必须 | 数据库 | 每次更新时写入，客户端上线时拉取 |
| 文件列表（元信息） | ✅ 必须 | 数据库 | ID、名称、hash、TTL、状态等 |
| 文件内容 | ✅ 短期保留 | 文件系统 | 按 TTL 清理（如 24 小时） |
| 操作日志 | 推荐 | 数据库 | 用于审计和问题排查 |
| 客户端在线状态 | 不要求 | 内存即可 | 断开后自动清空 |

**禁止使用的方案**：
- 内存变量 / 静态字典
- Session 存储
- 任何服务器重启会丢失的存储方式

**会话（账号状态）处理**：
- 账号信息存 `Users` 表
- 推荐使用 JWT 无状态认证
- 不使用服务器内存保存会话状态

**客户端重新上线时的恢复流程**：
1. 从数据库拉取文本内容
2. 从数据库拉取文件列表
3. 根据需要请求文件内容
4. 房间状态恢复如常

### 3.4 项目结构

```
SyncPad.sln
├── src/
│   ├── Server/
│   │   ├── SyncPad.Server          # ASP.NET Core Web API + SignalR
│   │   ├── SyncPad.Server.Core     # 服务端核心业务逻辑
│   │   └── SyncPad.Server.Data     # 数据访问层（EF Core）
│   ├── Client/
│   │   ├── SyncPad.Client          # .NET MAUI 跨平台客户端
│   │   └── SyncPad.Client.Core     # 客户端核心逻辑（平台无关）
│   ├── Web/
│   │   └── SyncPad.Web             # Blazor Web 网站客户端
│   └── Shared/
│       └── SyncPad.Shared          # 客户端与服务端共享的模型/DTO
└── tests/
    ├── SyncPad.Server.Tests        # 服务端单元测试与集成测试
    └── SyncPad.Client.Tests        # 客户端单元测试
```

**项目依赖关系**：
- `SyncPad.Server` → `SyncPad.Server.Core` → `SyncPad.Server.Data` → `SyncPad.Shared`
- `SyncPad.Client` → `SyncPad.Client.Core` → `SyncPad.Shared`
- `SyncPad.Web` → `SyncPad.Client.Core` → `SyncPad.Shared`

---

## 4. 核心业务需求

### 4.1 文本区域

- 单个文本区域（当前版本按账号划分，后续可扩展多房间）：
  - 同一账号下所有在线设备共享同一段文本
  - 文本编辑实时同步（节流广播）
- 功能：
  - 输入、删除、复制、粘贴
  - 长度在合理范围内（如几十 KB 级）
- 冲突处理：
  - 使用**节流广播**策略，避免每键一发
  - 服务器为权威源：
    - 如出现状态异常/乱序，客户端以服务器文本整体覆盖本地文本

### 4.2 文件区域

#### 桌面端（Windows/macOS）

- 支持拖入（上传）：
  - 将文件从系统文件管理器拖入文件区 → 开始上传
  - 文件元信息立即同步给其他设备（名称、大小、状态）
- 支持操作：
  - 单击/按钮：触发“加载/下载”（从预载切换为全速）
  - 删除：从列表中移除（详情见文件生命周期）

#### 移动端（iOS / Android）

- 不支持拖入/拖出
- 文件上传：
  - 点击“上传”按钮 → 系统文件选择器
  - 支持单选/多选
- 文件下载：
  - 单击文件 → 下载到本地（按平台常规行为）

#### 文件实时性

- 文件的**图标/列表项**应在上传端拖入/选择后立刻在所有设备显示
- 文件内容本身为**弱实时**：
  - 使用预载 + 按需提速策略

---

## 5. 账号与会话模型

### 5.1 账号模型

- 支持：
  - 注册
  - 登录
  - 修改密码
- 同一账号：
  - 允许多设备同时在线
- 数据所有权：
  - 文本与文件默认归账号所有（而非设备）

### 5.2 会话/房间模型

- 当前版本：
  - 每个账号默认一个“账号房间”
  - 文本和文件都归属于该账号房间
- 未来扩展：
  - 支持创建多个房间
  - 支持邀请其他账号加入房间协作

---

## 6. 文件模型与生命周期

### 6.1 文件命名与去重规则

- **同名文件不允许共存**：
  - 拖入/上传同名文件时：
    - 弹窗提示“是否覆盖”，风格参考 Windows
    - 提供选项：
      - 覆盖一次
      - 后续同名文件总是执行此操作（记住选择）
      - 取消
    - “记住选择”仅在本机生效（本地配置，不云同步）

- 内容去重：
  - 文件存储以内容 hash（例如 SHA-256）为基础
  - 相同 hash 的文件可复用同一物理存储，避免重复占用空间

### 6.2 文件删除

- UI 行为：
  - 用户点击“删除” → 文件从当前页面/列表中移除
- 服务端行为：
  - 不立即物理删除文件内容
  - 仅进行**逻辑删除**（标记为不可见）
  - 文件内容短期保留（TTL），用于：
    - 防止用户重复上传同一文件
    - 支撑覆盖后短时间内的“改回去”（从缓存复用）

### 6.3 文件缓存与清理

- 服务端：
  - 文件内容按 TTL 清理（例如 N 小时或 N 天，可配置）
  - 清理策略可配置但用户界面不需要显示

- 客户端：
  - 使用专用“临时缓存目录”存放预载文件
  - 客户端启动时清理上次残留缓存
  - 客户端正常退出时尝试清理缓存（异常退出由下次启动兜底）

---

## 7. 文本同步与网络状态

### 7.1 文本同步策略

- 使用 SignalR 实时同步文本：
  - 客户端本地编辑 → 节流后发送变更
  - 服务器转发给其他在线客户端
- 节流规则（示例）：
  - 间隔 X ms（如 100–300ms）聚合一次变更
  - 每次发送完整文本 or patch（实现阶段可选）

- 冲突与异常处理：
  - 出现乱序/异常时，客户端以服务器文本为准整体覆盖
  - 简化：不做复杂 CRDT，多人同时少量编辑在可接受范围

### 7.2 网络状态提示

- 客户端需展示最小网络状态：
  - 已连接
  - 连接中断
  - 正在重连

- 异常退出/崩溃兜底：
  - 客户端重启或重连后，以服务器状态为准同步本地
  - 本地未完成状态（未提交变更）丢弃

---

## 8. 配置与域名切换

### 8.1 配置存储位置

- 所有客户端配置存本地：
  - 主服务器域名（只读或默认）
  - 备用域名（用户可修改）
  - 客户端行为偏好（例如：是否记住同名文件覆盖策略）
- 不跨设备同步配置，避免不同平台行为互相影响

### 8.2 主域名 & 备用域名

- 设置页面：
  - 显示主域名（可固定/不可编辑）
  - 允许编辑备用域名
- 连接失败策略：
  - 主域名不可达时可尝试自动切换到备用域名
  - 或通过 UI 提示用户切换

---

## 9. 客户端平台行为细节

### 9.1 Windows

- 支持：
  - 托盘图标
  - 最小化到托盘
  - 不点“退出”则进程常驻
- 再次打开时：
  - 使用已有进程和已有 UI 状态
  - 不重复初始化核心资源

### 9.2 macOS

- 关闭窗口（红点）：
  - 仅关闭窗口，不退出应用
- Dock 图标仍在：
  - 点击 Dock 图标重新打开窗口
- 只有在菜单/右键明确“退出”时才销毁进程

### 9.3 iOS / Android

- 遵守系统默认生命周期：
  - 前台使用
  - 后台驻留由系统决定，应用不强求长时间常驻
- 文件上传/下载通过系统文件选择器 + 平台标准存储位置

---

## 10. 日志与审计

### 10.1 日志范围

需记录至少以下类型事件（可按重要度分级）：

- 登录/登出
- 注册、修改密码
- 连接/断开/重连
- 文本重要状态变化（例如服务端异常回滚）
- 文件相关：
  - 上传开始/结束
  - 覆盖操作（谁、什么时候、覆盖了哪个文件）
  - 删除操作（逻辑删除）

> 不记录文件内容本身，只记录操作元信息。

### 10.2 日志用途

- 排查同步问题
- 回顾覆盖/删除行为
- 为未来的“最近活动”类功能做准备

---

## 11. 测试要求

项目需要配套测试，至少包括：

### 11.1 核心业务逻辑测试（单元测试）

- 文本同步逻辑：
  - 节流规则是否按预期触发
  - 服务器文本为权威源的覆盖逻辑
- 文件去重逻辑：
  - 内容 hash 计算
  - 相同 hash 复用存储
- 文件状态流转：
  - 上传 → 可见 → 逻辑删除
  - 覆盖 → 新文件可见，旧内容仍在缓存

### 11.2 服务端 API 测试（集成测试）

- 账号体系：注册/登录/修改密码
- 文件上传/下载/覆盖/删除
- TTL 清理逻辑的基础验证

### 11.3 客户端行为测试（可分阶段实施）

- 网络断开 → 重连 → 状态恢复
- 多设备同时在线的文本/文件同步
- 同名文件覆盖弹窗逻辑（含“记住选择”）

---

## 12. 未来扩展点（占位）

后续可以考虑但不影响当前设计的扩展：

- 多房间 + 邀请其他账号共同协作
- 文本版本历史 / 撤销到服务端历史版本
- 文件版本历史 / 回收站 UI
- 更细粒度权限（共享码、只读链接等）

当前文档中的所有设计均尽量保证：

- **向前实现简单**
- **向后扩展空间足够**

---

_本版本为 SyncPad 开发文档 v1，用于指导当前阶段的实现与测试设计。_

